 version: 2
 jobs:
   build:
     docker:
       - image: circleci/php:7.1-apache
     environment:
       TRAKR_BASE_ENV: production
     steps:
       - checkout
       - run:
           name: Copy project directory to default apache root
           command: sudo cp -R ~/project /var/www/html/
       - run:
           name: Install localtunnel
           command: sudo apt-get update
       - run: sudo apt-get install curl software-properties-common
       - run: curl -sL https://deb.nodesource.com/setup_10.x | sudo bash -
       - run: sudo apt-get install nodejs
       - run: sudo npm install -g localtunnel
       - run: 
           name: Start apache
           command: sudo /etc/init.d/apache2 start
       - run:
           name: Start tunnel
           command: sudo lt --port 80 > /home/circleci/localtunnel.log
           background: true
       - run:
           name: Start visual test
           command: sudo git clone https://github.com/makehero/trakr_circleci.git /home/circleci/trakr_circleci
       - run: cd /home/circleci/trakr_circleci && sudo npm install
       - run: node /home/circleci/trakr_circleci/test.js
       - store_artifacts:
           path: /home/circleci/trakr_result.log
    
